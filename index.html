<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scala Calculator Pro</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Scala Calculator Pro">
    <meta name="description" content="Calcolatore professionale per scale con grandezze fisiche industriali">
    
    <!-- PWA Manifest inline per massima compatibilit√† -->
    <link rel="manifest" href="data:application/json;charset=utf-8,%7B%22name%22%3A%22Scala%20Calculator%20Pro%22%2C%22short_name%22%3A%22ScalaPro%22%2C%22description%22%3A%22Calcolatore%20professionale%20per%20scale%20con%20grandezze%20fisiche%22%2C%22start_url%22%3A%22.%2F%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23ffffff%22%2C%22theme_color%22%3A%22%23667eea%22%2C%22orientation%22%3A%22portrait%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fvia.placeholder.com%2F192x192%2F667eea%2Fffffff%3Ftext%3D%F0%9F%93%8A%22%2C%22sizes%22%3A%22192x192%22%2C%22type%22%3A%22image%2Fpng%22%7D%2C%7B%22src%22%3A%22https%3A%2F%2Fvia.placeholder.com%2F512x512%2F667eea%2Fffffff%3Ftext%3D%F0%9F%93%8A%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D">
    
    <!-- Icons for all platforms -->
    <link rel="icon" type="image/png" href="https://via.placeholder.com/32x32/667eea/ffffff?text=üìä">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/180x180/667eea/ffffff?text=üìä">
    
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f8fafc;
            --border: #e2e8f0;
            --text: #334155;
            --text-light: #64748b;
            --bg: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --primary: #818cf8;
            --secondary: #a78bfa;
            --bg: #0f172a;
            --text: #f1f5f9;
            --text-light: #94a3b8;
            --border: #334155;
            --light: #1e293b;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            color: var(--text);
            transition: all 0.3s ease;
            padding: 10px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: var(--bg);
            border-radius: 20px;
            box-shadow: 0 20px 40px var(--shadow);
            overflow: hidden;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px 20px;
            position: relative;
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .theme-toggle, .install-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover, .install-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .header h1 {
            font-size: 24px;
            text-align: center;
            margin-bottom: 8px;
        }

        .header p {
            font-size: 14px;
            opacity: 0.9;
            text-align: center;
        }

        .tabs {
            display: flex;
            background: var(--light);
            border-radius: 12px;
            padding: 4px;
            margin: 20px;
            margin-bottom: 0;
        }

        .tab {
            flex: 1;
            background: none;
            border: none;
            padding: 12px 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            color: var(--text-light);
        }

        .tab.active {
            background: var(--bg);
            color: var(--primary);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .form-container {
            padding: 25px 20px;
            display: none;
        }

        .form-container.active {
            display: block;
        }

        .calculation-mode {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--light);
            padding: 8px;
            border-radius: 12px;
        }

        .mode-btn {
            flex: 1;
            background: none;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            color: var(--text-light);
        }

        .mode-btn.active {
            background: var(--primary);
            color: white;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
        }

        .input-with-unit {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .input-group input, .input-group select {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: var(--bg);
            color: var(--text);
        }

        .input-group select {
            min-width: 100px;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .range-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .btn {
            padding: 16px 20px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            width: 100%;
            margin-bottom: 15px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px var(--shadow);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .result-container {
            margin-top: 25px;
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .result-container.show {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .result-card {
            background: linear-gradient(45deg, var(--success), #059669);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 15px;
        }

        .result-card.warning {
            background: linear-gradient(45deg, var(--warning), #d97706);
        }

        .result-card h3 {
            font-size: 16px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .result-value {
            font-size: 28px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
            word-break: break-all;
            margin-bottom: 8px;
        }

        .result-unit {
            font-size: 16px;
            opacity: 0.8;
        }

        .formula-display {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 12px;
            color: var(--text-light);
            border-left: 4px solid var(--primary);
            margin-bottom: 15px;
        }

        .presets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .preset-btn {
            padding: 12px;
            background: var(--light);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            text-align: center;
            transition: all 0.3s ease;
            color: var(--text);
        }

        .preset-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .error, .warning, .success {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            display: none;
            animation: shake 0.5s ease-out;
        }

        .error { background: linear-gradient(45deg, var(--danger), #dc2626); color: white; }
        .warning { background: linear-gradient(45deg, var(--warning), #d97706); color: white; }
        .success { background: linear-gradient(45deg, var(--success), #059669); color: white; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 12px;
            text-align: center;
            font-size: 14px;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .status-bar.show {
            transform: translateY(0);
        }

        .advanced-options {
            background: var(--light);
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        .precision-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }

        .precision-control input[type="range"] {
            flex: 1;
            accent-color: var(--primary);
        }

        @media (max-width: 480px) {
            .container {
                margin: 5px;
                max-width: none;
            }
            
            .range-group {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .result-value {
                font-size: 22px;
            }

            .presets {
                grid-template-columns: repeat(2, 1fr);
            }

            .tabs {
                margin: 15px 10px 0;
            }

            .tab {
                font-size: 12px;
                padding: 10px 6px;
            }
        }

        @media (display-mode: standalone) {
            body { padding-top: 20px; }
        }

        .history-item {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
        }

        .history-item .timestamp {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .history-item .calculation {
            font-size: 14px;
            color: var(--text);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-controls">
                <button class="theme-toggle" id="themeToggle">üåô</button>
                <button class="install-btn" id="installButton" style="display:none;">üì± Installa</button>
            </div>
            <h1>üìä Scala Calculator Pro</h1>
            <p>Calcolatore professionale con grandezze fisiche</p>
        </div>
        
        <div class="tabs">
            <button class="tab active" id="calcTab">üßÆ Calcolatore</button>
            <button class="tab" id="historyTab">üìà Cronologia</button>
            <button class="tab" id="converterTab">üîÑ Convertitore</button>
        </div>

        <!-- CALCULATOR TAB -->
        <div id="calculator" class="form-container active">
            <div class="calculation-mode">
                <button class="mode-btn active" id="directMode">Diretto</button>
                <button class="mode-btn" id="inverseMode">Inverso</button>
                <button class="mode-btn" id="findScaleMode">Trova Scala</button>
            </div>

            <div class="presets">
                <button class="preset-btn" id="tempPreset">üå°Ô∏è Temperatura</button>
                <button class="preset-btn" id="pressPreset">üîß Pressione</button>
                <button class="preset-btn" id="voltPreset">‚ö° Tensione</button>
                <button class="preset-btn" id="percPreset">üìä Percentuale</button>
            </div>

            <!-- DIRECT MODE -->
            <div id="direct-inputs">
                <div class="input-group">
                    <label for="valore">Valore da scalare:</label>
                    <div class="input-with-unit">
                        <input type="number" id="valore" step="any" placeholder="Inserisci valore" inputmode="decimal">
                        <select id="input-unit">
                            <option value="">-- Unit√† --</option>
                            <option value="¬∞C">¬∞C</option>
                            <option value="K">K</option>
                            <option value="¬∞F">¬∞F</option>
                            <option value="Pa">Pa</option>
                            <option value="bar">bar</option>
                            <option value="psi">psi</option>
                            <option value="V">V</option>
                            <option value="mV">mV</option>
                            <option value="A">A</option>
                            <option value="mA">mA</option>
                            <option value="%">%</option>
                            <option value="m">m</option>
                            <option value="cm">cm</option>
                            <option value="mm">mm</option>
                        </select>
                    </div>
                </div>

                <div class="range-group">
                    <div class="input-group">
                        <label for="v_min">V min (originale):</label>
                        <input type="number" id="v_min" step="any" placeholder="0" inputmode="decimal">
                    </div>
                    <div class="input-group">
                        <label for="v_max">V max (originale):</label>
                        <input type="number" id="v_max" step="any" placeholder="100" inputmode="decimal">
                    </div>
                </div>

                <div class="range-group">
                    <div class="input-group">
                        <label for="fondo_min">Scala min (target):</label>
                        <div class="input-with-unit">
                            <input type="number" id="fondo_min" step="any" placeholder="4" inputmode="decimal">
                            <select id="output-unit">
                                <option value="">-- Unit√† --</option>
                                <option value="mA">mA</option>
                                <option value="V">V</option>
                                <option value="%">%</option>
                                <option value="digit">digit</option>
                                <option value="count">count</option>
                            </select>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="fondo_max">Scala max (target):</label>
                        <input type="number" id="fondo_max" step="any" placeholder="20" inputmode="decimal">
                    </div>
                </div>
            </div>

            <!-- INVERSE MODE -->
            <div id="inverse-inputs" style="display: none;">
                <div class="input-group">
                    <label for="valore_scalato">Valore scalato ricevuto:</label>
                    <div class="input-with-unit">
                        <input type="number" id="valore_scalato" step="any" placeholder="Es: 12" inputmode="decimal">
                        <select id="scaled-unit">
                            <option value="">-- Unit√† --</option>
                            <option value="mA">mA</option>
                            <option value="V">V</option>
                            <option value="%">%</option>
                            <option value="digit">digit</option>
                        </select>
                    </div>
                </div>

                <div class="range-group">
                    <div class="input-group">
                        <label for="v_min_inv">V min (originale):</label>
                        <input type="number" id="v_min_inv" step="any" placeholder="0" inputmode="decimal">
                    </div>
                    <div class="input-group">
                        <label for="v_max_inv">V max (originale):</label>
                        <input type="number" id="v_max_inv" step="any" placeholder="100" inputmode="decimal">
                    </div>
                </div>

                <div class="range-group">
                    <div class="input-group">
                        <label for="fondo_min_inv">Scala min:</label>
                        <input type="number" id="fondo_min_inv" step="any" placeholder="4" inputmode="decimal">
                    </div>
                    <div class="input-group">
                        <label for="fondo_max_inv">Scala max:</label>
                        <input type="number" id="fondo_max_inv" step="any" placeholder="20" inputmode="decimal">
                    </div>
                </div>
            </div>

            <!-- FIND SCALE MODE -->
            <div id="find-scale-inputs" style="display: none;">
                <div class="input-group">
                    <label for="valore_find">Valore originale noto:</label>
                    <div class="input-with-unit">
                        <input type="number" id="valore_find" step="any" placeholder="Es: 50" inputmode="decimal">
                        <select id="find-input-unit">
                            <option value="">-- Unit√† --</option>
                            <option value="¬∞C">¬∞C</option>
                            <option value="Pa">Pa</option>
                            <option value="V">V</option>
                            <option value="%">%</option>
                        </select>
                    </div>
                </div>

                <div class="input-group">
                    <label for="valore_scalato_find">Valore scalato desiderato:</label>
                    <div class="input-with-unit">
                        <input type="number" id="valore_scalato_find" step="any" placeholder="Es: 12" inputmode="decimal">
                        <select id="find-output-unit">
                            <option value="">-- Unit√† --</option>
                            <option value="mA">mA</option>
                            <option value="V">V</option>
                            <option value="%">%</option>
                        </select>
                    </div>
                </div>

                <div class="range-group">
                    <div class="input-group">
                        <label for="v_min_find">V min:</label>
                        <input type="number" id="v_min_find" step="any" placeholder="0" inputmode="decimal">
                    </div>
                    <div class="input-group">
                        <label for="v_max_find">V max:</label>
                        <input type="number" id="v_max_find" step="any" placeholder="100" inputmode="decimal">
                    </div>
                </div>

                <div class="input-group">
                    <label for="fondo_min_find">Scala min fissa:</label>
                    <input type="number" id="fondo_min_find" step="any" placeholder="4" inputmode="decimal">
                </div>
            </div>

            <div class="advanced-options">
                <h4>‚öôÔ∏è Opzioni Avanzate</h4>
                <div class="precision-control">
                    <label>Precisione decimali:</label>
                    <input type="range" id="precision" min="0" max="8" value="3">
                    <span id="precision-value">3</span>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="scientific-notation">
                    <label for="scientific-notation">Notazione scientifica</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="show-formula">
                    <label for="show-formula">Mostra formula</label>
                </div>
            </div>

            <button class="btn btn-primary" id="calculateBtn">
                üßÆ Calcola
            </button>

            <div id="result-container" class="result-container">
                <div id="result-card" class="result-card">
                    <h3 id="result-title">Risultato:</h3>
                    <div class="result-value" id="result-value">0</div>
                    <div class="result-unit" id="result-unit"></div>
                </div>
                
                <div id="formula-display" class="formula-display" style="display: none;">
                    <strong>Formula utilizzata:</strong><br>
                    <span id="formula-text"></span>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="btn btn-secondary" id="copyBtn" style="flex: 1;">üìã Copia</button>
                    <button class="btn btn-secondary" id="saveBtn" style="flex: 1;">üíæ Salva</button>
                </div>
            </div>

            <div id="error" class="error"></div>
            <div id="warning" class="warning"></div>
            <div id="success" class="success"></div>

            <button class="btn btn-secondary" id="clearBtn" style="width: 100%; margin-top: 15px;">
                üóëÔ∏è Cancella tutto
            </button>
        </div>

        <!-- HISTORY TAB -->
        <div id="history" class="form-container">
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn btn-secondary" id="clearHistoryBtn" style="flex: 1;">üóëÔ∏è Cancella</button>
                <button class="btn btn-secondary" id="exportHistoryBtn" style="flex: 1;">üì§ Esporta</button>
            </div>
            <div id="history-list">
                <p style="text-align: center; color: var(--text-light); padding: 40px;">
                    üì≠ Nessun calcolo salvato
                </p>
            </div>
        </div>

        <!-- CONVERTER TAB -->
        <div id="converter" class="form-container">
            <div style="background: var(--light); padding: 15px; border-radius: 12px;">
                <h4>üîÑ Convertitore Unit√†</h4>
                <div class="input-group">
                    <label>Da:</label>
                    <div class="input-with-unit">
                        <input type="number" id="convert-from" step="any" placeholder="Valore" inputmode="decimal">
                        <select id="convert-from-unit">
                            <option value="celsius">¬∞C</option>
                            <option value="kelvin">K</option>
                            <option value="fahrenheit">¬∞F</option>
                            <option value="pascal">Pa</option>
                            <option value="bar">bar</option>
                            <option value="psi">psi</option>
                        </select>
                    </div>
                </div>
                <div class="input-group">
                    <label>A:</label>
                    <div class="input-with-unit">
                        <input type="number" id="convert-to" readonly placeholder="Risultato">
                        <select id="convert-to-unit">
                            <option value="celsius">¬∞C</option>
                            <option value="kelvin">K</option>
                            <option value="fahrenheit">¬∞F</option>
                            <option value="pascal">Pa</option>
                            <option value="bar">bar</option>
                            <option value="psi">psi</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" id="convertBtn">üîÑ Converti</button>
                <div id="conversion-result" style="background: var(--bg); padding: 12px; border-radius: 8px; border: 2px solid var(--border); font-family: monospace; font-size: 14px; color: var(--text); margin-top: 15px; display: none;">
                    Risultato conversione
                </div>
            </div>
        </div>
    </div>

    <div id="statusBar" class="status-bar">
        <span id="statusText">Scala Calculator Pro pronto! üöÄ</span>
    </div>

    <script>
        // Global variables
        let deferredPrompt;
        let isStandalone = false;
        let currentMode = 'direct';
        let currentTheme = localStorage.getItem('theme') || 'light';
        let calculationHistory = JSON.parse(localStorage.getItem('calculationHistory') || '[]');
        let currentResult = null;

        // Predefined scales for different applications
        const presets = {
            temperature: {
                name: 'Temperatura',
                v_min: 0, v_max: 100,
                fondo_min: 4, fondo_max: 20,
                input_unit: '¬∞C', output_unit: 'mA',
                description: '0-100¬∞C ‚Üí 4-20mA'
            },
            pressure: {
                name: 'Pressione',
                v_min: 0, v_max: 10,
                fondo_min: 4, fondo_max: 20,
                input_unit: 'bar', output_unit: 'mA',
                description: '0-10 bar ‚Üí 4-20mA'
            },
            voltage: {
                name: 'Tensione',
                v_min: 0, v_max: 10,
                fondo_min: 0, fondo_max: 100,
                input_unit: 'V', output_unit: '%',
                description: '0-10V ‚Üí 0-100%'
            },
            percentage: {
                name: 'Percentuale',
                v_min: 0, v_max: 100,
                fondo_min: 0, fondo_max: 4095,
                input_unit: '%', output_unit: 'digit',
                description: '0-100% ‚Üí 0-4095 digit'
            }
        };

        // Unit conversions
        const unitConversions = {
            celsius: {
                kelvin: (c) => c + 273.15,
                fahrenheit: (c) => c * 9/5 + 32
            },
            kelvin: {
                celsius: (k) => k - 273.15,
                fahrenheit: (k) => (k - 273.15) * 9/5 + 32
            },
            fahrenheit: {
                celsius: (f) => (f - 32) * 5/9,
                kelvin: (f) => (f - 32) * 5/9 + 273.15
            },
            pascal: {
                bar: (p) => p / 100000,
                psi: (p) => p / 6895
            },
            bar: {
                pascal: (b) => b * 100000,
                psi: (b) => b * 14.5038
            },
            psi: {
                pascal: (p) => p * 6895,
                bar: (p) => p / 14.5038
            }
        };

        // Initialize app
        function initApp() {
            try {
                loadTheme();
                setupEventListeners();
                restoreSession();
                
                // Check if PWA
                if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
                    isStandalone = true;
                }

                // Service Worker
                if ('serviceWorker' in navigator) {
                    const swCode = `
                        const CACHE_NAME = 'scala-calc-v1';
                        const urlsToCache = ['./'];
                        
                        self.addEventListener('install', event => {
                            event.waitUntil(
                                caches.open(CACHE_NAME).then(cache => {
                                    return cache.addAll(urlsToCache);
                                })
                            );
                        });
                        
                        self.addEventListener('fetch', event => {
                            event.respondWith(
                                caches.match(event.request).then(response => {
                                    return response || fetch(event.request);
                                })
                            );
                        });
                    `;
                    
                    const blob = new Blob([swCode], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(blob);
                    
                    navigator.serviceWorker.register(swUrl)
                        .then(() => console.log('SW registered'))
                        .catch(() => console.log('SW failed'));
                }

                // PWA install prompt
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    deferredPrompt = e;
                    if (!isStandalone) {
                        document.getElementById('installButton').style.display = 'block';
                    }
                });

                showStatus('Scala Calculator Pro pronto! üöÄ');
            } catch (error) {
                console.error('Init error:', error);
            }
        }

        function setupEventListeners() {
            // Theme toggle
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            // Install button
            document.getElementById('installButton').addEventListener('click', async () => {
                if (deferredPrompt) {
                    try {
                        deferredPrompt.prompt();
                        const { outcome } = await deferredPrompt.userChoice;
                        if (outcome === 'accepted') {
                            showStatus('App installata! üéâ');
                            document.getElementById('installButton').style.display = 'none';
                        }
                        deferredPrompt = null;
                    } catch (error) {
                        showError('Errore installazione');
                    }
                }
            });

            // Tab buttons
            document.getElementById('calcTab').addEventListener('click', () => showTab('calculator'));
            document.getElementById('historyTab').addEventListener('click', () => showTab('history'));
            document.getElementById('converterTab').addEventListener('click', () => showTab('converter'));

            // Mode buttons
            document.getElementById('directMode').addEventListener('click', () => setMode('direct'));
            document.getElementById('inverseMode').addEventListener('click', () => setMode('inverse'));
            document.getElementById('findScaleMode').addEventListener('click', () => setMode('find-scale'));

            // Preset buttons
            document.getElementById('tempPreset').addEventListener('click', () => loadPreset('temperature'));
            document.getElementById('pressPreset').addEventListener('click', () => loadPreset('pressure'));
            document.getElementById('voltPreset').addEventListener('click', () => loadPreset('voltage'));
            document.getElementById('percPreset').addEventListener('click', () => loadPreset('percentage'));

            // Action buttons
            document.getElementById('calculateBtn').addEventListener('click', calculate);
            document.getElementById('clearBtn').addEventListener('click', clearForm);
            document.getElementById('copyBtn').addEventListener('click', copyResult);
            document.getElementById('saveBtn').addEventListener('click', () => saveToHistory(currentResult));
            document.getElementById('clearHistoryBtn').addEventListener('click', clearHistory);
            document.getElementById('exportHistoryBtn').addEventListener('click', exportHistory);
            document.getElementById('convertBtn').addEventListener('click', convertUnits);

            // Precision slider
            document.getElementById('precision').addEventListener('input', (e) => {
                document.getElementById('precision-value').textContent = e.target.value;
            });

            // Unit converter auto-update
            ['convert-from', 'convert-from-unit', 'convert-to-unit'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', convertUnits);
                }
            });

            // Enter key for calculate
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.ctrlKey) {
                    const activeTab = document.querySelector('.form-container.active');
                    if (activeTab && activeTab.id === 'calculator') {
                        calculate();
                    }
                }
            });
        }

        function loadTheme() {
            document.documentElement.setAttribute('data-theme', currentTheme);
            const toggle = document.getElementById('themeToggle');
            if (toggle) {
                toggle.textContent = currentTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
            }
        }

        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', currentTheme);
            loadTheme();
            showStatus(currentTheme === 'dark' ? 'Tema scuro üåô' : 'Tema chiaro ‚òÄÔ∏è');
        }

        function showTab(tabName) {
            // Hide all containers
            document.querySelectorAll('.form-container').forEach(container => {
                container.classList.remove('active');
            });
            
            // Hide all tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected
            const container = document.getElementById(tabName);
            if (container) {
                container.classList.add('active');
            }

            // Activate correct tab button
            if (tabName === 'calculator') document.getElementById('calcTab').classList.add('active');
            if (tabName === 'history') document.getElementById('historyTab').classList.add('active');
            if (tabName === 'converter') document.getElementById('converterTab').classList.add('active');
        }

        function setMode(mode) {
            currentMode = mode;
            
            // Update mode buttons
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            if (mode === 'direct') document.getElementById('directMode').classList.add('active');
            if (mode === 'inverse') document.getElementById('inverseMode').classList.add('active');
            if (mode === 'find-scale') document.getElementById('findScaleMode').classList.add('active');
            
            // Show/hide input sections
            document.getElementById('direct-inputs').style.display = mode === 'direct' ? 'block' : 'none';
            document.getElementById('inverse-inputs').style.display = mode === 'inverse' ? 'block' : 'none';
            document.getElementById('find-scale-inputs').style.display = mode === 'find-scale' ? 'block' : 'none';
        }

        function loadPreset(presetName) {
            try {
                const preset = presets[presetName];
                if (!preset) return;

                if (currentMode === 'direct') {
                    document.getElementById('v_min').value = preset.v_min;
                    document.getElementById('v_max').value = preset.v_max;
                    document.getElementById('fondo_min').value = preset.fondo_min;
                    document.getElementById('fondo_max').value = preset.fondo_max;
                    document.getElementById('input-unit').value = preset.input_unit;
                    document.getElementById('output-unit').value = preset.output_unit;
                }
                
                showStatus(`Preset: ${preset.description}`);
            } catch (error) {
                showError('Errore caricamento preset');
            }
        }

        function calculate() {
            hideMessages();
            
            try {
                let result;
                
                if (currentMode === 'direct') {
                    result = calculateDirect();
                } else if (currentMode === 'inverse') {
                    result = calculateInverse();
                } else if (currentMode === 'find-scale') {
                    result = calculateFindScale();
                }
                
                if (result) {
                    displayResult(result);
                    currentResult = result;
                    if (navigator.vibrate) navigator.vibrate(50);
                }
            } catch (error) {
                showError(error.message);
                console.error('Calculation error:', error);
            }
        }

        function calculateDirect() {
            const valore = parseFloat(document.getElementById('valore').value);
            const v_min = parseFloat(document.getElementById('v_min').value);
            const v_max = parseFloat(document.getElementById('v_max').value);
            const fondo_min = parseFloat(document.getElementById('fondo_min').value);
            const fondo_max = parseFloat(document.getElementById('fondo_max').value);
            
            const inputUnit = document.getElementById('input-unit').value;
            const outputUnit = document.getElementById('output-unit').value;

            if (isNaN(valore) || isNaN(v_min) || isNaN(v_max) || isNaN(fondo_min) || isNaN(fondo_max)) {
                throw new Error('Inserisci tutti i valori numerici');
            }

            if (v_max === v_min) {
                throw new Error('V_max deve essere diverso da V_min');
            }

            if (valore < v_min || valore > v_max) {
                showWarning('Valore fuori range originale');
            }

            const numeratore = fondo_max - fondo_min;
            const denominatore = v_max - v_min;
            const risultato = (numeratore / denominatore) * (valore - v_min) + fondo_min;

            return {
                type: 'direct',
                input: { value: valore, unit: inputUnit },
                output: { value: risultato, unit: outputUnit },
                ranges: { v_min, v_max, fondo_min, fondo_max },
                formula: `X = ((${fondo_max} - ${fondo_min}) / (${v_max} - ${v_min})) √ó (${valore} - ${v_min}) + ${fondo_min}`
            };
        }

        function calculateInverse() {
            const valore_scalato = parseFloat(document.getElementById('valore_scalato').value);
            const v_min = parseFloat(document.getElementById('v_min_inv').value);
            const v_max = parseFloat(document.getElementById('v_max_inv').value);
            const fondo_min = parseFloat(document.getElementById('fondo_min_inv').value);
            const fondo_max = parseFloat(document.getElementById('fondo_max_inv').value);

            if (isNaN(valore_scalato) || isNaN(v_min) || isNaN(v_max) || isNaN(fondo_min) || isNaN(fondo_max)) {
                throw new Error('Inserisci tutti i valori numerici');
            }

            if (fondo_max === fondo_min) {
                throw new Error('Fondo_max deve essere diverso da Fondo_min');
            }

            const valore_originale = ((valore_scalato - fondo_min) * (v_max - v_min)) / (fondo_max - fondo_min) + v_min;

            return {
                type: 'inverse',
                input: { value: valore_scalato, unit: document.getElementById('scaled-unit').value },
                output: { value: valore_originale, unit: '' },
                ranges: { v_min, v_max, fondo_min, fondo_max },
                formula: `V = ((${valore_scalato} - ${fondo_min}) √ó (${v_max} - ${v_min})) / (${fondo_max} - ${fondo_min}) + ${v_min}`
            };
        }

        function calculateFindScale() {
            const valore = parseFloat(document.getElementById('valore_find').value);
            const valore_scalato = parseFloat(document.getElementById('valore_scalato_find').value);
            const v_min = parseFloat(document.getElementById('v_min_find').value);
            const v_max = parseFloat(document.getElementById('v_max_find').value);
            const fondo_min = parseFloat(document.getElementById('fondo_min_find').value);

            if (isNaN(valore) || isNaN(valore_scalato) || isNaN(v_min) || isNaN(v_max) || isNaN(fondo_min)) {
                throw new Error('Inserisci tutti i valori numerici');
            }

            if (v_max === v_min) {
                throw new Error('V_max deve essere diverso da V_min');
            }

            if (valore === v_min) {
                throw new Error('Il valore non pu√≤ essere uguale a V_min');
            }

            const fondo_max = ((valore_scalato - fondo_min) * (v_max - v_min)) / (valore - v_min) + fondo_min;

            return {
                type: 'find-scale',
                input: { value: valore, unit: document.getElementById('find-input-unit').value },
                output: { value: fondo_max, unit: document.getElementById('find-output-unit').value },
                target: { value: valore_scalato, unit: document.getElementById('find-output-unit').value },
                ranges: { v_min, v_max, fondo_min },
                formula: `Fondo_max = ((${valore_scalato} - ${fondo_min}) √ó (${v_max} - ${v_min})) / (${valore} - ${v_min}) + ${fondo_min}`
            };
        }

        function displayResult(result) {
            const precision = parseInt(document.getElementById('precision').value);
            const useScientific = document.getElementById('scientific-notation').checked;
            const showFormula = document.getElementById('show-formula').checked;

            let formattedValue;
            if (useScientific && Math.abs(result.output.value) >= 1000) {
                formattedValue = result.output.value.toExponential(precision);
            } else {
                formattedValue = result.output.value.toFixed(precision);
            }

            document.getElementById('result-title').textContent = getResultTitle(result.type);
            document.getElementById('result-value').textContent = formattedValue;
            document.getElementById('result-unit').textContent = result.output.unit || '';

            // Show formula if requested
            if (showFormula) {
                document.getElementById('formula-text').textContent = result.formula;
                document.getElementById('formula-display').style.display = 'block';
            } else {
                document.getElementById('formula-display').style.display = 'none';
            }

            // Color code result based on range
            const resultCard = document.getElementById('result-card');
            if (result.type === 'direct' && result.ranges && 
                (result.output.value < result.ranges.fondo_min || result.output.value > result.ranges.fondo_max)) {
                resultCard.className = 'result-card warning';
            } else {
                resultCard.className = 'result-card';
            }

            document.getElementById('result-container').classList.add('show');
        }

        function getResultTitle(type) {
            switch (type) {
                case 'direct': return 'Valore Scalato:';
                case 'inverse': return 'Valore Originale:';
                case 'find-scale': return 'Scala Massima:';
                default: return 'Risultato:';
            }
        }

        function copyResult() {
            if (!currentResult) {
                showError('Nessun risultato da copiare');
                return;
            }

            try {
                const text = `${currentResult.output.value.toFixed(3)} ${currentResult.output.unit}`;
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(text).then(() => {
                        showSuccess('Copiato negli appunti! üìã');
                    }).catch(() => {
                        showError('Impossibile copiare');
                    });
                } else {
                    showError('Copia non supportata');
                }
            } catch (error) {
                showError('Errore durante la copia');
            }
        }

        function saveToHistory(result) {
            if (!result) return;
            
            try {
                const historyItem = {
                    ...result,
                    timestamp: Date.now(),
                    id: Date.now()
                };

                calculationHistory.unshift(historyItem);
                if (calculationHistory.length > 50) {
                    calculationHistory = calculationHistory.slice(0, 50);
                }

                localStorage.setItem('calculationHistory', JSON.stringify(calculationHistory));
                updateHistoryDisplay();
                showSuccess('Salvato in cronologia! üíæ');
            } catch (error) {
                console.error('History save error:', error);
                showError('Errore salvando in cronologia');
            }
        }

        function updateHistoryDisplay() {
            const historyList = document.getElementById('history-list');
            
            if (calculationHistory.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 40px;">üì≠ Nessun calcolo salvato</p>';
                return;
            }

            historyList.innerHTML = calculationHistory.slice(0, 10).map(item => `
                <div class="history-item">
                    <div class="timestamp">${new Date(item.timestamp).toLocaleString('it-IT')}</div>
                    <div class="calculation">
                        ${getResultTitle(item.type)} ${item.output.value.toFixed(3)} ${item.output.unit || ''}
                        <br><small>Input: ${item.input.value} ${item.input.unit || ''}</small>
                    </div>
                </div>
            `).join('');
        }

        function clearHistory() {
            if (confirm('Cancellare tutta la cronologia?')) {
                try {
                    calculationHistory = [];
                    localStorage.removeItem('calculationHistory');
                    updateHistoryDisplay();
                    showSuccess('Cronologia cancellata! üóëÔ∏è');
                } catch (error) {
                    showError('Errore cancellazione cronologia');
                }
            }
        }

        function exportHistory() {
            if (calculationHistory.length === 0) {
                showError('Nessuna cronologia da esportare');
                return;
            }

            try {
                const csvData = 'Tipo,Valore Input,Unit√† Input,Valore Output,Unit√† Output,Data\n' +
                    calculationHistory.map(item => 
                        `${item.type},${item.input.value},${item.input.unit || ''},${item.output.value},${item.output.unit || ''},${new Date(item.timestamp).toLocaleString('it-IT')}`
                    ).join('\n');

                downloadFile(csvData, 'cronologia-calcoli.csv', 'text/csv');
            } catch (error) {
                showError('Errore esportazione cronologia');
            }
        }

        function downloadFile(content, filename, mimeType) {
            try {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showSuccess('File scaricato! üíæ');
            } catch (error) {
                console.error('Download error:', error);
                showError('Errore durante il download');
            }
        }

        function convertUnits() {
            try {
                const fromValue = parseFloat(document.getElementById('convert-from').value);
                const fromUnit = document.getElementById('convert-from-unit').value;
                const toUnit = document.getElementById('convert-to-unit').value;
                const resultDiv = document.getElementById('conversion-result');

                if (isNaN(fromValue)) {
                    document.getElementById('convert-to').value = '';
                    if (resultDiv) resultDiv.style.display = 'none';
                    return;
                }

                if (fromUnit === toUnit) {
                    document.getElementById('convert-to').value = fromValue.toFixed(6);
                    if (resultDiv) {
                        resultDiv.innerHTML = `<strong>${fromValue} ${getUnitSymbol(fromUnit)} = ${fromValue} ${getUnitSymbol(toUnit)}</strong>`;
                        resultDiv.style.display = 'block';
                    }
                    return;
                }

                let result;
                if (unitConversions[fromUnit] && unitConversions[fromUnit][toUnit]) {
                    result = unitConversions[fromUnit][toUnit](fromValue);
                } else {
                    throw new Error('Conversione non supportata');
                }

                document.getElementById('convert-to').value = result.toFixed(6);
                if (resultDiv) {
                    resultDiv.innerHTML = `<strong>${fromValue} ${getUnitSymbol(fromUnit)} = ${result.toFixed(6)} ${getUnitSymbol(toUnit)}</strong>`;
                    resultDiv.style.display = 'block';
                }
            } catch (error) {
                showError('Conversione non supportata: ' + error.message);
            }
        }

        function getUnitSymbol(unit) {
            const symbols = {
                celsius: '¬∞C', kelvin: 'K', fahrenheit: '¬∞F',
                pascal: 'Pa', bar: 'bar', psi: 'psi'
            };
            return symbols[unit] || unit;
        }

        function clearForm() {
            try {
                document.querySelectorAll('input[type="number"]').forEach(input => input.value = '');
                document.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
                hideMessages();
                const resultContainer = document.getElementById('result-container');
                if (resultContainer) {
                    resultContainer.classList.remove('show');
                }
                currentResult = null;
                showStatus('Campi cancellati üßπ');
            } catch (error) {
                showError('Errore cancellazione campi');
            }
        }

        function hideMessages() {
            ['error', 'warning', 'success'].forEach(id => {
                const element = document.getElementById(id);
                if (element) element.style.display = 'none';
            });
        }

        function showError(message) {
            const element = document.getElementById('error');
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
            }
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
        }

        function showWarning(message) {
            const element = document.getElementById('warning');
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
            }
        }

        function showSuccess(message) {
            const element = document.getElementById('success');
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
                setTimeout(() => element.style.display = 'none', 3000);
            }
        }

        function showStatus(message) {
            const statusText = document.getElementById('statusText');
            const statusBar = document.getElementById('statusBar');
            
            if (statusText && statusBar) {
                statusText.textContent = message;
                statusBar.classList.add('show');
                setTimeout(() => statusBar.classList.remove('show'), 3000);
            }
        }

        function restoreSession() {
            try {
                // Set default values first
                if (!document.getElementById('v_min').value) document.getElementById('v_min').value = '0';
                if (!document.getElementById('v_max').value) document.getElementById('v_max').value = '100';
                if (!document.getElementById('fondo_min').value) document.getElementById('fondo_min').value = '4';
                if (!document.getElementById('fondo_max').value) document.getElementById('fondo_max').value = '20';

                // Try to restore session
                const session = localStorage.getItem('lastSession');
                if (session) {
                    const data = JSON.parse(session);
                    const timeDiff = Date.now() - data.timestamp;
                    
                    if (timeDiff < 24 * 60 * 60 * 1000) { // 24 hours
                        Object.entries(data.values).forEach(([id, value]) => {
                            const element = document.getElementById(id);
                            if (element) element.value = value;
                        });
                        showStatus('Sessione ripristinata üîÑ');
                    }
                }

                updateHistoryDisplay();
            } catch (error) {
                console.log('Session restore error:', error);
            }
        }

        // Auto-save session
        function saveSession() {
            try {
                const values = {};
                document.querySelectorAll('input[type="number"], select').forEach(element => {
                    if (element.value) values[element.id] = element.value;
                });

                localStorage.setItem('lastSession', JSON.stringify({
                    values,
                    timestamp: Date.now()
                }));
            } catch (error) {
                console.log('Session save error:', error);
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', function() {
            try {
                initApp();
                
                // Setup auto-save with debounce
                const debouncedSave = debounce(saveSession, 1000);
                document.addEventListener('input', debouncedSave);
                
                // Network status
                window.addEventListener('online', () => showStatus('Online üåê'));
                window.addEventListener('offline', () => showStatus('Offline üì¥'));

                // Prevent zoom on iOS
                document.addEventListener('gesturestart', e => e.preventDefault());

                // App installed
                window.addEventListener('appinstalled', () => {
                    showStatus('App installata! üì±');
                    const installBtn = document.getElementById('installButton');
                    if (installBtn) installBtn.style.display = 'none';
                });

                console.log('üìä Scala Calculator Pro v2.0 caricato con successo');
                
                // Show initial status
                setTimeout(() => {
                    showStatus('Pronto per l\'uso! üöÄ');
                }, 1000);

                // iOS install hint
                setTimeout(() => {
                    if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream && !isStandalone) {
                        showStatus('üí° Per installare: Condividi > Aggiungi alla Home');
                    }
                }, 5000);

            } catch (error) {
                console.error('DOMContentLoaded error:', error);
            }
        });
    </script>
</body>
</html>